name: è‡ªåŠ¨éƒ¨ç½²åˆ°Vercel

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ç¯å¢ƒå˜é‡
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: å®‰è£…ä¾èµ–
      run: pnpm install
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: pnpm run lint
      
    - name: æ ·å¼æ£€æŸ¥
      run: pnpm run lint:style
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: pnpm run test:ci
      
    - name: æ„å»ºé¡¹ç›®
      run: pnpm run build

  # éƒ¨ç½²åˆ°Vercelï¼ˆä»…åœ¨mainåˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œï¼‰
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°Vercel
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å®‰è£…Vercel CLI
      run: npm install --global vercel@latest
      
    - name: æ‹‰å–Vercelç¯å¢ƒä¿¡æ¯
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: æ„å»ºé¡¹ç›®
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: éƒ¨ç½²åˆ°Vercel
      run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "ç”Ÿäº§ç¯å¢ƒåœ°å€ï¼šhttps://vibe-coding-frontend.vercel.app"
        
    - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        exit 1