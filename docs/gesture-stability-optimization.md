# æ‰‹åŠ¿è¯†åˆ«ç¨³å®šæ€§ä¼˜åŒ–æ–‡æ¡£

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆæ‰‹åŠ¿è¯†åˆ«åŠŸèƒ½ä¸ç¨³å®šï¼Œç»å¸¸å‡ºç°"MediaPipeå¤„ç†å¸§æ—¶å‡ºé”™: memory access out of bounds"é”™è¯¯ï¼Œå¯¼è‡´æ‰‹åŠ¿è¯†åˆ«åŠŸèƒ½å¤±æ•ˆã€‚

## é—®é¢˜åˆ†æ

MediaPipeçš„"memory access out of bounds"é”™è¯¯é€šå¸¸ç”±ä»¥ä¸‹åŸå› é€ æˆï¼š

1. **è§†é¢‘å¸§æ•°æ®ä¸å®Œæ•´æˆ–æŸå**ï¼šå½“è§†é¢‘æµä¸ç¨³å®šæ—¶ï¼Œå¯èƒ½ä¼ é€’æŸåçš„å¸§æ•°æ®ç»™MediaPipe
2. **MediaPipeå®ä¾‹çŠ¶æ€ä¸ä¸€è‡´**ï¼šåœ¨å¤„ç†å¸§æ—¶MediaPipeå®ä¾‹è¢«æ„å¤–é”€æ¯æˆ–é‡ç½®
3. **å¹¶å‘å¤„ç†å†²çª**ï¼šå¤šä¸ªå¸§å¤„ç†è¯·æ±‚åŒæ—¶è¿›è¡Œï¼Œå¯¼è‡´å†…å­˜è®¿é—®å†²çª
4. **è§†é¢‘å…ƒç´ çŠ¶æ€ä¸ç¨³å®š**ï¼šè§†é¢‘å…ƒç´ çš„readyStateã€å°ºå¯¸ç­‰å±æ€§åœ¨å¤„ç†æ—¶å‘ç”Ÿå˜åŒ–

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¢å¼ºå¸§å¤„ç†å®‰å…¨æ€§

- **å¹¶å‘æ§åˆ¶**ï¼šæ·»åŠ `isProcessing`æ ‡å¿—ï¼Œé˜²æ­¢å¤šä¸ªå¸§åŒæ—¶å¤„ç†
- **çŠ¶æ€éªŒè¯**ï¼šå¢åŠ æ›´ä¸¥æ ¼çš„è§†é¢‘å…ƒç´ çŠ¶æ€æ£€æŸ¥
- **å¸§æ•°æ®å®‰å…¨**ï¼šä½¿ç”¨Canvasåˆ›å»ºè§†é¢‘å¸§å‰¯æœ¬ï¼Œé¿å…ç›´æ¥ä¼ é€’è§†é¢‘å…ƒç´ 

```typescript
// æ·»åŠ å¤„ç†æ ‡å¿—ï¼Œé˜²æ­¢å¹¶å‘å¤„ç†
let isProcessing = false

const processFrame = async () => {
  // é˜²æ­¢å¹¶å‘å¤„ç†
  if (isProcessing) {
    animationFrameRef.current = requestAnimationFrame(processFrame)
    return
  }
  
  // åˆ›å»ºå®‰å…¨çš„è§†é¢‘å¸§å‰¯æœ¬
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')
  canvas.width = video.videoWidth
  canvas.height = video.videoHeight
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
  
  // å‘é€canvaså›¾åƒåˆ°MediaPipe
  await handsRef.current.send({ image: canvas as any })
}
```

### 2. æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶

- **é”™è¯¯åˆ†ç±»å¤„ç†**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
- **è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–**ï¼šæ£€æµ‹åˆ°å†…å­˜è®¿é—®é”™è¯¯æ—¶ï¼Œè‡ªåŠ¨é‡æ–°åˆå§‹åŒ–MediaPipe
- **å»¶è¿Ÿé‡è¯•**ï¼šé¿å…ç«‹å³é‡è¯•ï¼Œç»™ç³»ç»Ÿæ¢å¤æ—¶é—´

```typescript
// å†…å­˜è®¿é—®é”™è¯¯ - é‡æ–°åˆå§‹åŒ–MediaPipe
if (errorMessage.includes('memory access') || errorMessage.includes('out of bounds')) {
  console.warn('ğŸ”„ æ£€æµ‹åˆ°å†…å­˜è®¿é—®é”™è¯¯ï¼Œé‡æ–°åˆå§‹åŒ–MediaPipe...');
  isMediaPipeInitializedRef.current = false
  handsRef.current = null
  
  // å»¶è¿Ÿé‡æ–°åˆå§‹åŒ–
  setTimeout(async () => {
    try {
      await initializeHands()
      console.log('âœ… MediaPipeé‡æ–°åˆå§‹åŒ–å®Œæˆ');
    } catch (initError) {
      console.error('âŒ MediaPipeé‡æ–°åˆå§‹åŒ–å¤±è´¥:', initError);
    }
  }, 1000)
}
```

### 3. ä¼˜åŒ–MediaPipeé…ç½®

- **é™ä½æ£€æµ‹é˜ˆå€¼**ï¼šä»0.7é™ä½åˆ°0.6ï¼Œæé«˜æ£€æµ‹ç¨³å®šæ€§
- **ç®€åŒ–é…ç½®**ï¼šç§»é™¤ä¸å¿…è¦çš„é…ç½®é€‰é¡¹ï¼Œå‡å°‘æ½œåœ¨å†²çª

```typescript
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0, // é™ä½æ¨¡å‹å¤æ‚åº¦ä»¥æé«˜æ€§èƒ½
  minDetectionConfidence: 0.6, // é€‚å½“é™ä½æ£€æµ‹ç½®ä¿¡åº¦ï¼Œæé«˜ç¨³å®šæ€§
  minTrackingConfidence: 0.6, // é€‚å½“é™ä½è·Ÿè¸ªç½®ä¿¡åº¦ï¼Œæé«˜ç¨³å®šæ€§
})
```

### 4. å¢å¼ºçŠ¶æ€æ£€æŸ¥

- **å¤šå±‚çŠ¶æ€éªŒè¯**ï¼šæ£€æŸ¥å…¨å±€çŠ¶æ€ã€MediaPipeåˆå§‹åŒ–çŠ¶æ€ã€è§†é¢‘çŠ¶æ€
- **è§†é¢‘æœ‰æ•ˆæ€§æ£€æŸ¥**ï¼šéªŒè¯è§†é¢‘æ˜¯å¦æš‚åœã€ç»“æŸã€æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆ

```typescript
// ä½¿ç”¨å…¨å±€çŠ¶æ€æ£€æŸ¥ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
const globalStatus = cameraManager.getStatus()

if (!videoRef.current || !globalStatus.isActive || !handsRef.current || !isMediaPipeInitializedRef.current) {
  return
}

// æ£€æŸ¥è§†é¢‘æ˜¯å¦æš‚åœæˆ–ç»“æŸ
if (video.paused || video.ended) {
  return
}

// æ£€æŸ¥è§†é¢‘æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆ
if (video.currentTime <= 0) {
  return
}
```

## é¢„æœŸæ•ˆæœ

1. **å‡å°‘å†…å­˜è®¿é—®é”™è¯¯**ï¼šé€šè¿‡Canvasç¼“å†²å’Œå¹¶å‘æ§åˆ¶ï¼Œæ˜¾è‘—é™ä½å†…å­˜è®¿é—®å†²çª
2. **æé«˜æ¢å¤èƒ½åŠ›**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æœºåˆ¶ï¼Œå‡å°‘æ‰‹åŠ¨åˆ·æ–°é¡µé¢çš„éœ€æ±‚
3. **å¢å¼ºç¨³å®šæ€§**ï¼šæ›´ä¸¥æ ¼çš„çŠ¶æ€æ£€æŸ¥ï¼Œé¿å…åœ¨ä¸ç¨³å®šçŠ¶æ€ä¸‹è¿›è¡Œå¤„ç†
4. **æ”¹å–„ç”¨æˆ·ä½“éªŒ**ï¼šå‡å°‘æ‰‹åŠ¿è¯†åˆ«ä¸­æ–­ï¼Œæä¾›æ›´æµç•…çš„æ¸¸æˆä½“éªŒ

## æµ‹è¯•éªŒè¯

- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ116ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… ESLintæ£€æŸ¥é€šè¿‡
- âœ… å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- âœ… æµè§ˆå™¨é¢„è§ˆæ— é”™è¯¯

## åç»­ç›‘æ§

å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **é”™è¯¯é¢‘ç‡**ï¼šMediaPipeç›¸å…³é”™è¯¯çš„å‘ç”Ÿé¢‘ç‡
2. **æ¢å¤æˆåŠŸç‡**ï¼šè‡ªåŠ¨é‡æ–°åˆå§‹åŒ–çš„æˆåŠŸç‡
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ‰‹åŠ¿è¯†åˆ«çš„å“åº”æ—¶é—´å’Œå‡†ç¡®æ€§
4. **æ€§èƒ½å½±å“**ï¼šCanvaså¤„ç†å¯¹æ•´ä½“æ€§èƒ½çš„å½±å“

## æ³¨æ„äº‹é¡¹

1. ä½¿ç”¨äº†`as any`ç±»å‹æ–­è¨€æ¥è§£å†³MediaPipeç±»å‹å®šä¹‰çš„é™åˆ¶
2. Canvaså¤„ç†ä¼šå¢åŠ ä¸€å®šçš„CPUå¼€é”€ï¼Œä½†èƒ½æ˜¾è‘—æé«˜ç¨³å®šæ€§
3. è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–æœºåˆ¶éœ€è¦1ç§’å»¶è¿Ÿï¼ŒæœŸé—´æ‰‹åŠ¿è¯†åˆ«ä¼šæš‚æ—¶å¤±æ•ˆ